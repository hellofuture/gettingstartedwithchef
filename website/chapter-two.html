<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Getting Started with Chef</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Learn how to configure, manage and provision cloud servers with Chef by following practical examples with real world applications.">
    <meta name="author" content="Andy Gale for Hello Future Ltd">

    <!-- CSS -->
    <link href="assets/cerulean/bootstrap.min.css" rel="stylesheet">
    <link href="assets/css/base.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../assets/js/html5shiv.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
<!--     <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="..`icon.png"> -->
  </head>

  <body>

    <div id="wrap">
       <div class="container">
            <div class="page-header">
                <h1>Getting Started with Chef</h1>
                <div>By Andy Gale</div>
            </div>

            <p><a href="index.html">&lt;&lt; Chapter 1: Introducing Chef</a></p>

            <h2>2. Introducing Chef Server</h2>

            <p>This chapter will extend on the building blocks of the previous chapter and introduce better ways of working than just SSH and using Chef in a client and server model.</p>

            <h3>Chef client and server</h3>

            <p>As well as using Chef on a single box with <strong>chef-solo</strong> it is also possible to use Chef in a client/server model. The Chef server stores and distributes our cookbooks and other Chef configuration when contacted by a client running the <strong>chef-client</strong> command. The <strong>chef-client</strong> command is the client/server version of <strong>chef-solo</strong>.</p>

            <p>Storing the configuration inside a Chef Server instead of inside a file like <strong>web.json</strong> as we did in the previous chapter allows us to easily manage the configuration of our servers from our workstation instead. This has an obvious advantage when dealing with a large number of servers and allows us to easily provision new servers with knife.</p>

            <h3>Node</h3>

            <p>At this point it's prudent to introduce you to some Chef terminology. A computer, virtual machine or cloud instance you are running <strong>chef-solo</strong> or <strong>chef-client</strong> on is called a <strong>node</strong>. This differs slightly from what Chef calls a <strong>client</strong>. A client can also be your workstation that you don't run <strong>chef-client</strong> on but do use <strong>knife</strong> to manage your Chef server with.</p>

            <h3>Workstation setup</h3>

            <p>We will now setup your workstation so you can edit you Chef recipes in your favourite text editor. We'll also install Git to allow us to keep track of changes any our Chef Repository.</p>

            <p>Choose your workstation operating system:</p>

            <div class="tabbable">
                <ul class="nav nav-tabs">
                    <li class="active"><a href="#mac" data-toggle="tab">Mac</a></li>
                    <li><a href="#linux" data-toggle="tab">Linux</a></li>
                    <li><a href="#windows" data-toggle="tab">Windows</a></li>
                </ul>

                <div class="tab-content">
                    <div class="tab-pane active" id="mac">
                        <p>Open Terminal (which can be found in <em>Utilities</em> under <em>Applications</em>).</p>

                        <h3>Install Git</h3>
                        <p>If you are already using Macports you should continue to use that otherwise follow the instructions for Homebrew.</p>

                        <h4>Homebrew</h4>
                        <p>Install Homebrew if it's not already installed.</p>
                        
                        <pre class="terminal">andy@bubbles:~# ruby -e "$(curl -fsSL https://raw.github.com/mxcl/homebrew/go)"</pre>

                        <p>Install git.</p>

                        <pre class="terminal">andy@bubbles:~# brew install git</pre>
                        
                        <h4>Macports</h4>
                        <p>If you are already using Macports install git with the following commands.</p>
                        <pre class="terminal">andy@bubbles:~# sudo port selfupdate
andy@bubbles:~# sudo port install git-core +bash_completion</pre>

                        <h3>Install Chef</h3>

                        <pre class="terminal">andy@bubbles:~# curl -L https://www.opscode.com/chef/install.sh | sudo bash
Thank you for installing Chef!</pre>

                        <p>Save some typing by adding the various Chef commands to your $PATH.</p>
                        <pre class="terminal">andy@bubbles:~# echo 'export PATH="/opt/chef/embedded/bin:$PATH"' &gt;&gt; ~/.bash_profile &amp;&amp; source ~/.bash_profile</pre>
                       

                    </div>
                    <div class="tab-pane" id="linux">
                        <p>Install <strong>curl</strong> if it is not already installed. Then install Chef.</p>
                        
                        <pre class="terminal">andy@bubbles:~# curl -L https://www.opscode.com/chef/install.sh | sudo bash
Thank you for installing Chef!</pre>

                        <p>Save some typing by adding the various Chef commands to your $PATH.</p>
                        <pre class="terminal"  echo 'export PATH="/opt/chef/embedded/bin:$PATH"' &gt;&gt; ~/.bash_profile &amp;&amp; source ~/.bash_profile</pre>

                    </div>
                    <div class="tab-pane" id="windows">
                        <ol>
                            <li>Download <a href="https://msysgit.googlecode.com/files/Git-1.8.1.2-preview20130201.exe" target="_blank">Git Installer for Windows</a>, run and accept the default options to install.</l1>
                            <li>Download <a href="http://opscode.com/chef/install.msi" target="_blank">Windows Chef Installer</a>, run and accept the default options to install.</li>
                        </ol>
                    </div>
                </div>    
            </div>

            <h3>Hosted Chef</h3>

            <p>Opscode, the makers of Chef provide a service called <a href="http://www.opscode.com/hosted-chef/" target="_blank">Hosted Chef</a> which is a Chef Server as a service. They offer a free tier which is good for 5 nodes so is ideal to help us get started.</p>

            <p>Follow the instructions to sign up on the website and log in.</p>

            <p>Now we've signed up we will download some files that will allow us to use our Hosted Chef account with knife. Visit <a href="https://manage.opscode.com/organizations" target="_blank">https://manage.opscode.com/organizations</a>.</p>


            <p><img class="img-rounded" alt="Hosted Chef - Organizations page screenshot" src="assets/img/hosted-chef-organizations.png" /></p>

            <p>Click the <strong>Generate knife config</strong> link. Download the knife.rb file that is generated.</p>

            <p>Then click the <strong>Regenerate validation key</strong> link. Press OK to the alert and download the .pem file.</p>

            <p>Now visit <a href="https://www.opscode.com/account/password" target="_blank">https://www.opscode.com/account/password</a>.</p>

            <p><img class="img-rounded" alt="Opscode reset user key screenshot" src="assets/img/opscode-reset-key.png" /></p>

            <p>Press the <strong>Get a new key</strong> button and download the .pem file.</p>

            <h3>Using Hosted Chef</h3>

            <p>We'll now use Hosted Chef along with the chef repository we made in the previous chapter. Firstly, let's download our chef repository.</p>

            <pre class="terminal">andy@bubbles:~# <span class="cmd">wget http://gettingstartedwithchef.com/downloads/cp1.tgz</span>
--2013-06-09 13:36:15--  http://gettingstartedwithchef.com/downloads/cp1.tgz
Resolving gettingstartedwithchef.com (gettingstartedwithchef.com)... 80.68.93.116
Connecting to gettingstartedwithchef.com (gettingstartedwithchef.com)|80.68.93.116|:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 300046 (293K) [text/plain]
Saving to: ‘cp1.tgz’

100%[===============================================================================>] 300,046     1.78MB/s   in 0.2s   

2013-06-09 13:36:15 (1.78 MB/s) - ‘cp1.tgz’ saved [300046/300046]
andy@bubbles:~# <span class="cmd">tar zxf cp1.tgz</span>
andy@bubbles:~# <span class="cmd">cd chef-repo</span></pre>

        <p>We now have everything we need, so let's start using Hosted Chef. Firstly, we need to tell knife to use Hosted Chef. To do this we need copy the files we just downloaded from Hosted Chef to our repository.</p>
 
        <pre class="terminal">andy@bubbles:~/chef-repo# <span class="cmd">mv ~/Downloads/*.pem .chef/</span>
andy@bubbles:~/chef-repo# <span class="cmd">mv ~/Downloads/knife.rb .chef/</span></pre>

        <p>Let's check that knife can talk to Hosted Chef.</p>

        <pre class="terminal">andy@bubbles:~/chef-repo# <span class="cmd">knife client list</span>
<span class="code2highlight">org_name</span>-validator</pre>

        <p>&quot;org_name&quot; will be whatever you entered as your organisation name when signing up for Hosted Chef.</p>

        <h3>Uploading Cookbooks</h3>

        <p>Before we can configure our node with <strong>chef-client</strong>, we need to upload our cookbooks to the Chef server. We do that with <strong>knife</strong>.</p>

        <pre class="terminal">andy@bubbles:~/chef-repo# <span class="cmd">knife cookbook upload --all</span>
Uploading apache2      [1.6.0]
Uploading apt          [1.9.0]
Uploading aws          [0.100.6]
Uploading build-essential [1.3.4]
Uploading database     [1.3.12]
Uploading mysql        [2.1.2]
Uploading openssl      [1.0.2]
Uploading php          [1.1.8]
Uploading phpapp       [0.1.0]
Uploading postgresql   [2.2.2]
Uploading xfs          [1.1.0]
Uploading xml          [1.1.2]
Uploaded all cookbooks.</pre>

        <h3>Roles</h3>

        <p>We used a single JSON file to configure our node with <strong>chef-solo</strong> but we if we have multiple nodes we should probably find a better solution to this. A Chef <strong>role</strong> allows us to group configuration for types of nodes together. We'll expand on this in a later chapter but for now we'll create a role for our Wordpress setup.</p>

        <pre class="terminal">andy@bubbles:~/chef-repo# <span class="cmd">knife role create phpapp</span></pre>
        
        <p>You may receive the following error if you do not have an EDITOR environment variable set.</p>

        <pre class="terminal"><span class="chef-error">ERROR:</span> RuntimeError: Please set EDITOR environment variable</pre>

        <p>You can resolve this quickly with the <strong>--editor</strong> option. e.g. <strong>--editor vi</strong> or <strong>--editor nano</strong> etc.</p> 
        
        <p>We are then presented with the basic structure of the role as a JSON file.</p>

        <pre class="editor">{
  "name": "phpapp",
  "description": "",
  "json_class": "Chef::Role",
  "default_attributes": {
  },
  "override_attributes": {
  },
  "chef_type": "role",
  "run_list": [

  ],
  "env_run_lists": {
  }
}
</pre>

        <p>We'll go through what the fields actually mean. The <strong>name</strong> you can probably guess - the name of the role. It's a good idea to put something descriptive in the <strong>description</strong> field. You may remember that we discussed attributes in the last chapter, <strong>default_attributes</strong> allows us to set attributes and <strong>override_attributes</strong> let's us specify attributes that override attributes defined as defaults elsewhere. We've already created a <strong>run_list</strong> in our JSON file in the last chapter so let's add that first. It's save to ignore the fields that have not been mentioned for now.</p>

        <pre class="editor">{
  "name": "phpapp",
  "description": "",
  "json_class": "Chef::Role",
  "default_attributes": {
  },
  "override_attributes": {
  },
  "chef_type": "role",
  "run_list": [
    <span class="code2add">"recipe[apt]", "recipe[phpapp]"</span>
  ],
  "env_run_lists": {
  }
}
</pre>

        <p>Add the code in green. We now need to specify some attributes. We can't specify all the attributes we used with <strong>chef-solo</strong> in our JSON file in the last chapter as roles should be generic. Things like virtual host names or MySQL access details such as user names and passwords should be defined elsewhere.</p>




        <h3>Bootstrapping a node with Knife</h3>

        <p><a href="https://vimeo.com/61380630" target="_blank">Create a new Ubuntu instance in the Rackspace Cloud</a> or use your virtual machine software to create a new Ubuntu box.</p>





        </div>
        <div id="push"></div>
    </div>

    <div id="footer">
      <div class="container">
        <p class="muted credit">&copy; <a href="http://hellofutu.re">Hello Future Ltd</a>. Registered in England and Wales. Company No: 08378526<br />
        Created with <a href="http://twitter.github.com/bootstrap/">Twitter Bootstrap</a> and <a href="http://bootswatch.com/cerulean/" target="_blank">Bootswatch Cerulean.</a></p>
      </div>
    </div>

    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-38853378-2']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
    <script type="text/javascript" src="assets/js/lib/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="assets/js/gswc.js"></script>
  </body>
</html>

