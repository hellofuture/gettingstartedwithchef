<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Managing multiple nodes with Chef - Getting started with Chef</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Learn how to configure, manage and provision cloud servers with Chef by following practical examples with real world applications.">
    <meta name="author" content="Andy Gale for Hello Future Ltd">

    <!-- CSS -->
    <link href="assets/cerulean/bootstrap.min.css" rel="stylesheet">
    <link href="assets/css/base.css?v=3" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../assets/js/html5shiv.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
<!--     <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="..`icon.png"> -->
  </head>

  <body>

    <div id="wrap">
      <div id="hellofutureinfo">
        <div class="container"><p>The authors of this online book <a href="http://hellofutu.re">Hello Future</a> offer cloud automation and Chef training and consultancy.<br/>Say <a href="mailto:hello@hellofutu.re">hello@hellofutu.re</a> for more information or <a href="https://twitter.com/hellofutur3">follow us on Twitter</a>.</p></div>
      </div>

       <div class="container">
          <div class="page-header">
            <ul id="gswc-chapter-switcher" class="nav nav-pills">
              <li class="active dropdown">
                <a class="dropdown-toggle" data-toggle="dropdown" href="#">Chapters <b class="caret"></b></a>
                <ul class="pull-right dropdown-menu">
                  <li><a href="index.html">Home</a></li>
                  <li><a href="first-steps-with-chef.html">First steps with Chef</a></li>
                  <li><a href="introducing-chef-server.html">Introducing Chef Server</a></li>
                  <li class="active"><a href="managing-multiple-nodes-with-chef.html">Managing multiple nodes with Chef</a></li>
                </ul>
              </li>
            </ul>
            <h1>Getting started with Chef</h1>
            <div>By Andy Gale</div>
          </div>

          <ul class="pager">
            <li class="previous"><a href="introducing-chef-server.html">&larr; Introducing Chef Server</a></li>
          </ul>

          <h2>3. Managing multiple nodes with Chef</h2>
        
          <p>This chapter extends our cookbook to work with multiple web sites and support multiple nodes. It introduces slightly more advanced Chef concepts like data bags and search.</p>

          <h3>More than one WordPress site?</h3>

          <p>Our <strong>phpapp</strong> cookbook is all very well but what if we want host more than one WordPress site on our web server? What if we want to add new sites in the future without changing our cookbook? We need somewhere to store this data somewhere and <a href="http://docs.opscode.com/essentials_data_bags.html" target="_blank">data bags</a> are ideal.</p>

          <h3>Data bags</h3>

          <p>A <em>data bag</em> is a collection of bits of JSON called <em>data bag items</em>, indexed by an ID, that Chef allows us to use and search in our recipes. Let's use knife to create our data bag.</p>

          <p>Return to your chef-repo from the second chapter.</p>

          <p>Type the following on your workstation to create a data bag called <strong>wp-sites</strong>.</p>

          <p></p>

          <pre class="terminal">$ <span class="cmd">knife data bag create wp-sites</span>
Created data_bag[wp-sites]</pre>

          <p>We'll call our site hosts <strong>website1.example.com</strong> and <strong>website2.example.com</strong>. Imaginative I know. Let's create our first website as the data bag item <strong>website1</strong>.</p>

          <pre class="terminal">$ <span class="cmd">knife data bag create wp-sites website1</span></pre>

        
          <p>You may receive the following error if you do not have an EDITOR environment variable set.</p>

          <pre class="terminal"><span class="chef-error">ERROR:</span> RuntimeError: Please set EDITOR environment variable</pre>

          <p>You can resolve this quickly with the <strong>--editor</strong> option. e.g. <strong>--editor vi</strong> or <strong>--editor nano</strong> etc.</p> 
        
          <p>Now we will add our per site configuration as JSON attributes. As well as a different hostname for each site, we want to be able to be able to configure a separate database name, user, host and password for each of the sites on our server so we'll include these details in our data bag.</p>

          <pre class="editor">{
  "id": "website1"<span class="code2add">,
  "host": "website1.example.com",
  "db_name": "website1",
  "db_user": "website1",
  "db_password": "212b09752d173876a84d374333ae1ffe",
  "db_host": "localhost"</span>
}</pre>
        
        <p>Add the code in green. Save the file. We now have our first data bag item. Let's create another.</p>

        <pre class="terminal">$ <span class="cmd">knife data bag create wp-sites website2</span></pre>

        <p>Our second website will be similar to the first!</p>

        <pre class="editor">{
  "id": "website2"<span class="code2add">,
  "host": "website2.example.com",
  "db_name": "website2",
  "db_user": "website2",
  "db_password": "e50586910465ad767b36d11ec3fe323c",
  "db_host": "localhost"</span>
}</pre>

        <p>Add the code in green. Save the file. We now have two data bags! Now time for something cool!</p>

        <h3>Chef Shell</h3>

        <p>As well as cookbook, recipes and knife, we can also use <a href="http://docs.opscode.com/chef_shell.html" target="_blank">chef-shell</a> to interact with Chef. We can use it to take our first steps interacting with our data bag.</p>

        <pre class="terminal">$ <span class="cmd">chef-shell -c .chef/knife.rb</span>
loading configuration: none (standalone session)
Session type: standalone
Loading...done.

This is the chef-shell.
 Chef Version: 11.x.x
 http://www.opscode.com/chef
 http://wiki.opscode.com/display/chef/Home

run `help' for help, `exit' or ^D to quit.

Ohai2u andy@computer!
chef &gt;
</pre>

        <p>Those familiar with Python or the IRb (Interactive Ruby Shell) already know how you use <strong>chef-shell</strong>. We can just type cookbook code in and see what happens! Useful for experimenting or debugging.</p>

        <p>Let's get our data bag from the Chef Server. From inside chef-shell.</p>

        <pre class="terminal">chef &gt; <span class="cmd">databags('wp-sites').list</span>
 => [data_bag_item["wp-sites", "website2", {"id"=>"website2", "host"=>"website2.example.com", "db_name"=>"website2", "db_user"=>"website2", "db_password"=>"e50586910465ad767b36d11ec3fe323c", "db_host"=>"localhost"}], data_bag_item["wp-sites", "website1", {"id"=>"website1", "host"=>"website1.example.com", "db_name"=>"website1", "db_user"=>"website1", "db_password"=>"212b09752d173876a84d374333ae1ffe", "db_host"=>"localhost"}]] </pre>

        <p>We can see our entire data bag is returned. Let's find our which data bag item contains the host <strong>&quot;website2.example.com&quot;</strong>.</p>

        <pre class="terminal">chef &gt; <span class="cmd">databags('wp-sites').search "host:website2.example.com"</span>
 => [data_bag_item["wp-sites", "website2", {"id"=>"website2", "host"=>"website2.example.com", "db_name"=>"website2", "db_user"=>"website2", "db_password"=>"e50586910465ad767b36d11ec3fe323c", "db_host"=>"localhost"}]]</pre>

        <p>You can see one data bag item is returned.</p>

        <p>We'll come back to chef-shell later. Press Ctrl-D to quit.</p>

        <h3>Using data bags in your recipes</h3>

        <p>Load <em>cookbooks/phpapp/recipes/default.rb</em> in your text editor.</p>

<!--           <p>At this point you'll need to make up two different DNS names for our two virtual hosts. You can set them up properly if you like but for now we'd recommend you just add them to your hosts file. Of course we don't yet know what IP address to point them at!</p>
           <a href="http://www.rackspace.com/knowledge_center/article/how-do-i-modify-my-hosts-file" target="_blank">Rackspace have a handy guide</a> if you don't know how to do it for you workstation.</p>

 -->

        </div>
        <div id="push"></div>
    </div>

    <div id="footer">
      <div class="container">
        <p class="muted credit">&copy; <a href="http://hellofutu.re">Hello Future Ltd</a>. Registered in England and Wales. Company No: 08378526<br />
        Created with <a href="http://twitter.github.com/bootstrap/">Twitter Bootstrap</a> and <a href="http://bootswatch.com/cerulean/" target="_blank">Bootswatch Cerulean.</a></p>
      </div>
    </div>

    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-38853378-2']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
    <script type="text/javascript" src="assets/js/lib/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="assets/js/gswc.js"></script>
  </body>
</html>

